---
title: Building benjeffrey.com with Hakyll
description: This post describes how I use Hakyll, a static-site generator written in Haskell, to build and deploy my website.
tags: web-development
date: 2013-04-24
---

A few weeks ago I finally bought the [benjeffrey.com][] domain name,
which I've now moved to as my main presence on the
<abbr title="World Wide Web">WWW</abbr>. So change your bookmarks
and update your contacts, because [this is
my new home][benjeffrey.com][^email]!

After all, [benjeffrey.net][] was the first webpage I'd ever really put
online (back when I was paying Â£10/year for [a domain name and shared
hosting][fasthostingdirect]) and now my web presence was looking
rather... meh. Certainly not the standard you'd expect from a student of
<abbr title="Computer Science">Informatics</abbr>!


I wanted the following for my new web setup:

* a static-site generator to build the content, because <del>that's what
    all the cool kids are doing</del> I liked the idea of my website
    being portable
* a sensible way to deploy my website, whether that meant using
* the ability to write posts in [Pandoc Markdown][pandoc md];
    it supports LaTex expressions, as well as tables and footnotes,
    making writing more complex documents in Markdown a whole lot easier.

I came across a cool little project by the name of [Hakyll][], while
browsing the [Pandoc wiki][] looking for better content templates.

Hakyll performs much the same function as [Jekyll][] and similar
software. The primary difference between Hakyll and other static site
generation tools is that Hakyll is written in the functional programming
language Haskell. Here at the University of Edinburgh, we spent our first
semester getting to grips with FP in this language, so I wanted to ease
it in to my day-to-day programming.


Customising Hakyll
------------------

### Basic setup

**Requirements:** GHC and [Cabal][], Haskell's package-management system.

You should install Hakyll through Cabal, so it can pull in its (many)
dependencies, then install the default Hakyll script into an
empty directory with `hakyll-init`[^cabal-scripts]:

```bash
cabal install hakyll
hakyll-init {directory}
cd {directory}
git init
```

My `.gitignore` file includes the following lines (alongside
[GitHub's Haskell defaults][haskell-gi]) so as not to commit the files
generated by Hakyll:

```bash
# Hakyll compiled site
_cache
_site
site
hakyll
```

Next thing, I gave my script a more descriptive name:

```bash
mv site.hs hakyll.hs
```

One of the most interesting things about the Hakyll package is that it
can be considered more of a *library* than a program per se. The Hakyll
*script* installed in the directory by `hakyll-init` is a regular old
Haskell source file, which imports the Hakyll package and chains together
its functions to describe a compiler for the static site! To generate the
static site, simply compile the Haskell source and run the resulting
executable's `build` command:

```bash
ghc --make hakyll.hs
./hakyll build
```

[Hakyll's tutorials][hakyll-cmds] explain the various commands that the `hakyll`
executable now provides.

The following sections describe the various pieces of functionality in
[my hakyll.hs][hakyll-source] which aren't included by
default.

### Site Icon

My site icon lives at `images/favicon.ico` before compilation. The
following Hakyll rule copies it to `favicon.ico` in the compiled site
directory:

```haskell
main :: IO ()
main = hakyll $ do
    -- ...

    -- copy site icon to `favicon.ico`
    match "images/favicon.ico" $ do
            route   (constRoute "favicon.ico")
            compile copyFileCompiler
    -- ...
```

As well as moving the ICO file, I also added

```html
<head>
    <!-- ... -->
    <link rel="shortcut icon" href="/favicon.ico" />
    <!-- ... -->
</head>
```

into the [default template][] `head` element, just
in case. To be honest, this really makes the Hakyll rule redundant, as
the `href` attribute can be anything. But then where'd be the fun in
that?


### Copying `humans.txt` and `robots.txt` to the Web Root

The following rule just ensures that the site [`robots.txt`](/robots.txt)
(advice for web-crawlers) and [`humans.txt`](/humans.txt) (detailing the
technologies and people involved in development (i.e. me!))

```haskell
-- copy humans.txt and robots.txt to web root
match (fromList ["humans.txt", "robots.txt"]) $ do
    route   idRoute
    compile copyFileCompiler
```


### Compiling Documents with Pandoc to the Web Root

I kept the location of my CV on my old site [pretty
short](http://benjeffrey.net/cv), by saving the HTML file in the document
root of the webserver as `/cv`, stripping the file suffix. This required
some Apache `.htaccess` rules for it to actually serve the file as a
webpage, but it worked. As you can imagine, updating the HTML by hand got
pretty tiring, and I'd much prefer to keep my CV as a Markdown file.

The default Hakyll script has a rule for copying static files into the
generated web root. In order to compile the Markdown file `cv.md` to an
HTML page throught Pandoc, I used the same rule, only replacing the
`copyFileCompiler` with the `pandocCompiler`, then setting it to run
through the templates.

```haskell
-- Compile static pages to web root with Pandoc
match (fromList ["cv.md"]) $ do
    route   $ setExtension ""
    compile $ pandocCompiler
        >>= loadAndApplyTemplate "templates/default.html" defaultContext
        >>= relativizeUrls
```

The above Hakyll rule compiles the listed files through Pandoc, and
places them in the web root of the compiled site.


### Compiling SCSS through Hakyll

**Requirements:** [Sass][] and [Compass][] gems (installed systemwide).

I decided to use Zurb's [Foundation web framework][foundation] on this
site, as an experiment in "things which aren't Bootstrap". I have a bit
of experience with Sass, and it's quite nice to be able to limit
"div-itis" by using [Foundation's Sass mixin support][foundation-sass]!

[Compass][] is a must for developing Sass stylesheets, collecting
essential functions such as [sticky footers][] in one handy place, and
is required by Foundation anyway.

Luckily, rather than having `compass watch` constantly running when
editing the Sass stylesheets, The Haddock docs for Hakyll [describe a rule
for compiling SCSS to CSS][hakyll-scss] using the `unixFilter`.

This next rule (based on the one in Hakyll's docs) compiles matched Sass
stylesheets when you issue the Hakyll `build` command, but also tells the
`scss` command to enable Compass and to compress the output:

```haskell
match "scss/app.scss" $do
    route   $ gsubRoute "scss/" (const "css/") `composeRoutes` setExtension "css"
    compile $ getResourceString
        >>= withItemBody (unixFilter "sass" ["-s", "--scss", "--compass", "--style", "compressed"])
        >>= return . fmap compressCss
```

### Changing the URL Structure

Wherever `setExtension` is used for HTML pages, I've fed it an empty
string, so that webpages don't have an ugly `.html` suffix on the end.

```haskell
match "post/*" $ do
    route $ setExtension ""
    compile $ pandocCompiler
        >>= loadAndApplyTemplate "templates/post.html"    postCtx
        >>= loadAndApplyTemplate "templates/default.html" postCtx
        >>= relativizeUrls
```

Just in case, the templates include the following `meta` tag in the
`head`, to ensure that each page is detected as HTML:

```html
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
```

As you may have guessed from the above snippet, I've also moved the
`posts` directory to `post` to generate URLs like `/post/blog-post`.

This frees up the `/posts` URL as the [Post Archive](/posts), as I
originally had file/folder conflicts when syncing to the server.



Deploying with Hakyll
---------------------

Hakyll has a great feature hidden away in its documentation:
the [deploy command][]. It turns out that you can specify an arbitrary
command in the configuration for Hakyll to execute when you run:

```bash
hakyll-deploy
```

You could set this to execute a separate script for better modularity,
but since I just `rsync` the changes up to my server (along with an nginx
server directive) I've put the entire command inside the Hakyll
configuration. Hakyll needs to be told to run with your new
configuration, so you'll have to replace the `hakyll :: Rules a -> IO ()`
function in the line

```haskell
main = hakyll $ do
```

with the `hakyllWith :: Configuration -> Rules a -> IO ()` function.

The start of my `hakyll.hs` file looks like:

```haskell
--------------------------------------------------------------------------------
config :: Configuration
config = defaultConfiguration
        {   deployCommand = "rsync -avz -e ssh ./_site/ parsley:/var/www/benjeffrey.com/ && rsync -avz -e ssh ./nginx parsley:/etc/nginx/sites_enabled/benjeffrey.com"}

--------------------------------------------------------------------------------
main :: IO ()
main = hakyllWith config $ do
    -- ...
```


Summary
-------

[benjeffrey.com][] is built and deployed (as of
2013-04) through a combination of:

* Hakyll
* Sass & Compass
* Nginx
* Git
* SSH

My final directory structure now looks like:

```
{directory}
|-- images
    \- ...
|-- post
    \- ...
|-- scss
   |- app.scss
   |- ...
   |- foundation
       \ ...
|-- templates
     \- ...
|-- config.rb (for Compass)
|-- cv.md
|-- hakyll.hs
|-- hakyll
|-- humans.txt
|-- index.html
|-- nginx
|-- posts
|-- README.md
 \- robots.txt
```

and my current Hakyll configuration [is available on GitHub][hakyll-gh].



<!-- footnotes -->

[^email]: My email address will still be <mail@benjeffrey.net> though.
    I'm still figuring out how to best add email to my new domain,
    or even if it's worth adding yet *another* email address to my
    collection! I may look into doing some sort of mail forwarding,
    either at the DNS or the mailbox level, at a later date.

[^cabal-scripts]: If you can't run the `hakyll-init` command, you may
    need to add the local Cabal binary folder to your shell's `$PATH`
    variable with the following lines in your shell config:

    ```bash
    ### ~/.profile

    # Cabal executables
    PATH=$PATH:$HOME/.cabal/bin
    ```


<!-- links -->

[benjeffrey.com]: http://benjeffrey.com
[benjeffrey.net]: http://benjeffrey.net
[fasthostingdirect]: http://www.fasthostingdirect.co.uk/
[Jekyll]: http://jekyllrb.com/
[Octopress]: http://octopress.org/
[GitHub Pages]: http://pages.github.com/
[Hakyll]: http://jaspervdj.be/hakyll/
[Hakyll tutorials]: http://jaspervdj.be/hakyll/tutorials.html
[Hakyll reference]: http://jaspervdj.be/hakyll/reference/index.html
[Bootstrap]: http://twitter.github.io/bootstrap/
[foundation]: http://foundation.zurb.com/
[Cabal]: http://www.haskell.org/cabal/
[INF-YT]: http://inf-yt.org.uk/
[daylerees]: http://daylerees.com/
[ST colour schemes]: https://github.com/daylerees/colour-schemes
[COLOURlovers]: http://www.colourlovers.com/
[Pandoc wiki]: https://github.com/jgm/pandoc/wiki/Pandoc-Extras
[pandoc md]: http://johnmacfarlane.net/pandoc/README.html#pandocs-markdown
[haskell-gi]: https://github.com/github/gitignore/blob/master/Haskell.gitignore
[hakyll-source]: https://github.com/jeffbr13/benjeffrey.com/blob/master/hakyll.hs
[robots]: https://en.wikipedia.org/wiki/Robots_exclusion_standard
[default template]: https://github.com/jeffbr13/benjeffrey.com/blob/master/templates/default.html
[foundation-sass]: http://foundation.zurb.com/docs/sass.html
[sticky footers]: http://compass-style.org/reference/compass/layout/sticky_footer/
[Michael Walker]: http://www.barrucadu.co.uk/
[Citation Needed]: http://citationneeded.me/
[Compass]: http://compass-style.org/
[Sass]: http://sass-lang.com/
[cn-scss]: http://citationneeded.me/hakyll.html#templates-css-static-and-wrapped-files
[hakyll-scss]: http://jaspervdj.be/hakyll/reference/Hakyll-Core-UnixFilter.html
[hakyll-cmds]: http://jaspervdj.be/hakyll/tutorials/02-basics.html
[deploy command]: http://jaspervdj.be/hakyll/reference/Hakyll-Core-Configuration.html#v:deployCommand
[hakyll-gh]: https://github.com/jeffbr13/benjeffrey.com/blob/master/hakyll.hs
